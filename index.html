<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì FIB-4 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NAFLD</title>

  <!-- PWA Settings -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-512.png">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('‚úÖ Service Worker registered'))
        .catch(err => console.error('Service Worker failed:', err));
    }
  </script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f9;
    }
    .card {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                  0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }
    .input-field {
      border: 1px solid #cbd5e1;
      padding: 10px;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    .input-field:focus {
      border-color: #3b82f6;
      outline: none;
    }
  </style>
</head>

<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-lg bg-white p-6 sm:p-8 rounded-xl card">
    <img src="icons/logo.png" width="100%">
    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì FIB-4</h1>
    <p class="text-center text-gray-600 mb-6">
      ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏†‡∏≤‡∏ß‡∏∞‡∏û‡∏±‡∏á‡∏ú‡∏∑‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ö (Advanced Fibrosis) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ NAFLD/MASLD
    </p>

    <!-- Input Form -->
    <div class="space-y-4">
      <label class="block">
        <span class="text-gray-700 font-semibold">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</span>
        <input type="number" id="inputAge" class="mt-1 block w-full input-field" min="1" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 45">
      </label>
      <label class="block">
        <span class="text-gray-700 font-semibold">‡∏Ñ‡πà‡∏≤ AST (U/L)</span>
        <input type="number" id="inputAST" class="mt-1 block w-full input-field" min="1" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 35">
      </label>
      <label class="block">
        <span class="text-gray-700 font-semibold">‡∏Ñ‡πà‡∏≤ ALT (U/L)</span>
        <input type="number" id="inputALT" class="mt-1 block w-full input-field" min="1" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 30">
      </label>
      <label class="block">
        <span class="text-gray-700 font-semibold">‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î (10‚Åπ/L)</span>
        <input type="number" id="inputPlatelets" class="mt-1 block w-full input-field" min="10" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 250">
      </label>
    </div>

    <button onclick="calculateFIB4()" 
      class="w-full mt-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-300">
      ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì FIB-4
    </button>

    <!-- Result -->
    <div id="resultContainer" class="mt-8 p-5 rounded-xl border-2 border-gray-200 hidden">
      <h2 class="text-xl font-bold mb-3 text-gray-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
      <p id="fib4Score" class="text-2xl font-mono mb-4 text-center"></p>
      <div id="riskDisplay" class="p-4 rounded-lg text-center font-bold"></div>
      <div id="recommendation" class="mt-4 text-gray-700"></div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4">
      <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl">
        <h3 class="text-xl font-bold text-red-600 mb-3">‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p id="errorMessage" class="text-gray-700 mb-4">
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        </p>
        <button onclick="document.getElementById('errorModal').classList.add('hidden')" 
          class="w-full py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition">
          ‡∏ï‡∏Å‡∏•‡∏á
        </button>
      </div>
    </div>

    <p class="text-xs text-gray-400 mt-6 text-center">
      *‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ
    </p>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ -->
  <button id="installBtn" 
          class="hidden fixed bottom-6 right-6 bg-blue-600 text-white px-5 py-3 rounded-full shadow-lg font-bold hover:bg-blue-700 transition">
    üì≤ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ
  </button>

  <script>
    // ==========================
    //  PWA INSTALL HANDLER
    // ==========================
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBtn').classList.remove('hidden');
    });

    document.getElementById('installBtn').addEventListener('click', async () => {
      document.getElementById('installBtn').classList.add('hidden');
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User ${outcome === 'accepted' ? 'installed' : 'dismissed'} the app`);
      deferredPrompt = null;
    });

    window.addEventListener('appinstalled', () => {
      console.log('‚úÖ App installed successfully!');
    });

    // ==========================
    //  FIB-4 CALCULATION LOGIC
    // ==========================
    function calculateFIB4() {
      const age = parseFloat(document.getElementById('inputAge').value);
      const ast = parseFloat(document.getElementById('inputAST').value);
      const alt = parseFloat(document.getElementById('inputALT').value);
      const platelets = parseFloat(document.getElementById('inputPlatelets').value);

      document.getElementById('resultContainer').classList.add('hidden');
      document.getElementById('errorModal').classList.add('hidden');

      if (isNaN(age) || isNaN(ast) || isNaN(alt) || isNaN(platelets) || age <= 0 || ast <= 0 || alt <= 0 || platelets <= 0) {
        document.getElementById('errorMessage').textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á (‡∏≠‡∏≤‡∏¢‡∏∏, AST, ALT, ‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î)";
        document.getElementById('errorModal').classList.remove('hidden');
        return;
      }

      const fib4 = (age * ast) / (platelets * Math.sqrt(alt));
      const roundedFib4 = fib4.toFixed(2);

      let riskLevel = '';
      let riskClass = '';
      let recommendationText = '';

      if (fib4 < 1.3) {
        riskLevel = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ (Low Risk)';
        riskClass = 'bg-green-100 text-green-800 border-green-300';
        recommendationText = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô FIB-4 ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô 2-3 ‡∏õ‡∏µ';
      } else if (fib4 >= 1.3 && fib4 <= 2.67) {
        riskLevel = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡∏ä‡∏±‡∏î (Indeterminate Risk)';
        riskClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
        recommendationText = '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏£‡∏ß‡∏à LSM (FibroScan/MRE) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
      } else {
        riskLevel = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á (High Risk)';
        riskClass = 'bg-red-100 text-red-800 border-red-300';
        recommendationText = '‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤';
      }

      document.getElementById('fib4Score').textContent = `FIB-4 Score: ${roundedFib4}`;
      const riskDisplay = document.getElementById('riskDisplay');
      riskDisplay.textContent = riskLevel;
      riskDisplay.className = `p-4 rounded-lg text-center font-bold ${riskClass}`;
      document.getElementById('recommendation').innerHTML = `<p class="font-semibold mb-2">‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</p><p class="p-3 rounded-lg border-l-4 ${riskClass.split(' ')[2].replace('text','border')}">${recommendationText}</p>`;
      document.getElementById('resultContainer').classList.remove('hidden');
    }
  </script>
</body>
</html>
